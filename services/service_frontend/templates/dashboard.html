<!DOCTYPE html>
<html>
<head>
    <title>ALFR3D Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/dashboard">Dashboard</a>
        <a href="/control">Control</a>
    </nav>

    <!-- Dash app will be inserted here -->
    <div id="dash-container">
        <div class="page">
            <h2 class="page-title">ALFR3D: Container Dashboard</h2>
             <div class="user-canvas">
                 <div class="user-cluster" id="users-cluster">
                     <div class="cluster-title">Online Users</div>
                 </div>
             </div>
             <div class="canvas">
                 <!-- Container nodes will be dynamically added here -->
                 <div class="node-card" id="daemon-card" style="width: 240px; height: 120px;">
                    <div class="node-title">daemon</div>
                    <div class="node-health" id="daemon-health" style="background-color: #27ae60;"></div>
                    <div class="metrics-list">
                        <div class="metric-row">
                            <div class="metric-name">CPU</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="daemon-cpu-bar" style="width: 25%;"></div>
                            </div>
                            <div class="metric-value" id="daemon-cpu-value">25%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">MEM</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="daemon-mem-bar" style="width: 40%;"></div>
                            </div>
                            <div class="metric-value" id="daemon-mem-value">40%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">ERR</div>
                            <div class="metric-pill" id="daemon-errors">0</div>
                        </div>
                    </div>
                </div>

                 <div class="node-card" id="environment-card" style="width: 240px; height: 120px;">
                    <div class="node-title">environment</div>
                    <div class="node-health" id="environment-health" style="background-color: #27ae60;"></div>
                    <div class="metrics-list">
                        <div class="metric-row">
                            <div class="metric-name">CPU</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="environment-cpu-bar" style="width: 15%;"></div>
                            </div>
                            <div class="metric-value" id="environment-cpu-value">15%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">MEM</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="environment-mem-bar" style="width: 30%;"></div>
                            </div>
                            <div class="metric-value" id="environment-mem-value">30%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">ERR</div>
                            <div class="metric-pill" id="environment-errors">0</div>
                        </div>
                    </div>
                </div>

                 <div class="node-card" id="frontend-card" style="width: 240px; height: 120px;">
                    <div class="node-title">frontend</div>
                    <div class="node-health" id="frontend-health" style="background-color: #27ae60;"></div>
                    <div class="metrics-list">
                        <div class="metric-row">
                            <div class="metric-name">CPU</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="frontend-cpu-bar" style="width: 35%;"></div>
                            </div>
                            <div class="metric-value" id="frontend-cpu-value">35%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">MEM</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="frontend-mem-bar" style="width: 45%;"></div>
                            </div>
                            <div class="metric-value" id="frontend-mem-value">45%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">ERR</div>
                            <div class="metric-pill" id="frontend-errors">0</div>
                        </div>
                    </div>
                </div>

                 <div class="node-card" id="device-card" style="width: 240px; height: 120px;">
                    <div class="node-title">device</div>
                    <div class="node-health" id="device-health" style="background-color: #27ae60;"></div>
                    <div class="metrics-list">
                        <div class="metric-row">
                            <div class="metric-name">CPU</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="device-cpu-bar" style="width: 20%;"></div>
                            </div>
                            <div class="metric-value" id="device-cpu-value">20%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">MEM</div>
                            <div class="metric-bar-bg">
                                <div class="metric-bar-fill" id="device-mem-bar" style="width: 35%;"></div>
                            </div>
                            <div class="metric-value" id="device-mem-value">35%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">ERR</div>
                            <div class="metric-pill" id="device-errors">0</div>
                        </div>
                    </div>
                </div>

                 <div class="node-card" id="mysql-card" style="width: 240px; height: 120px;">
                    <div class="node-title">MySQL</div>
                    <div class="node-health" id="mysql-health" style="background-color: #27ae60;"></div>
                    <div class="metrics-list">
                        <div class="metric-row">
                            <div class="metric-name">CONN</div>
                            <div class="metric-pill" id="mysql-connections">5</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-name">TBL</div>
                            <div class="metric-pill" id="mysql-tables">8</div>
                        </div>
                    </div>
                </div>

                  <div class="node-card" id="user-card" style="width: 240px; height: 120px;">
                     <div class="node-title">user</div>
                     <div class="node-health" id="user-health" style="background-color: #27ae60;"></div>
                     <div class="metrics-list">
                         <div class="metric-row">
                             <div class="metric-name">CPU</div>
                             <div class="metric-bar-bg">
                                 <div class="metric-bar-fill" id="user-cpu-bar" style="width: 18%;"></div>
                             </div>
                             <div class="metric-value" id="user-cpu-value">18%</div>
                         </div>
                         <div class="metric-row">
                             <div class="metric-name">MEM</div>
                             <div class="metric-bar-bg">
                                 <div class="metric-bar-fill" id="user-mem-bar" style="width: 28%;"></div>
                             </div>
                             <div class="metric-value" id="user-mem-value">28%</div>
                         </div>
                         <div class="metric-row">
                             <div class="metric-name">ERR</div>
                             <div class="metric-pill" id="user-errors">0</div>
                         </div>
                     </div>
                 </div>

                  <!-- Animated Kafka topic connection lines -->
                 <svg class="connection-lines" width="100%" height="100%" viewBox="0 0 1000 750">
                     <defs>
                         <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                             <stop offset="0%" style="stop-color:#61dafb;stop-opacity:0.8" />
                             <stop offset="50%" style="stop-color:#61dafb;stop-opacity:1" />
                             <stop offset="100%" style="stop-color:#61dafb;stop-opacity:0.8" />
                         </linearGradient>
                     </defs>
                  </svg>
             </div>
             <div class="legend">
                <span>Legend:</span>
                <span class="legend-pill up"></span> <span>Healthy</span>
                <span class="legend-pill warn"></span> <span>Warning</span>
                <span class="legend-pill down"></span> <span>Down</span>
            </div>
            <div class="kafka-legend">
                <span>Kafka Connections:</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample speak-line"></span> speak</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample google-line"></span> google</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample user-line"></span> user</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample frontend-user-line"></span> frontend-user</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample device-line"></span> device</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample device-user-line"></span> device-user</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample device-daemon-line"></span> device_daemon</span>
                <span class="kafka-legend-item"><span class="kafka-line-sample environment-line"></span> environment</span>
            </div>
        </div>
    </div>

     <script>
        const services = ['daemon', 'environment', 'frontend', 'device', 'mysql', 'user', 'guests', 'residents'];
         const connections = [
             {from: 'daemon', to: 'environment', class: 'speak-line'},
             {from: 'daemon', to: 'frontend', class: 'google-line'},
             {from: 'daemon', to: 'user', class: 'user-line'},
             {from: 'frontend', to: 'user', class: 'frontend-user-line'},
             {from: 'frontend', to: 'daemon', class: 'device-daemon-line'},
             {from: 'environment', to: 'daemon', class: 'environment-line'},
             {from: 'daemon', to: 'device', class: 'device-line'},
             {from: 'device', to: 'user', class: 'device-user-line'},
             {from: 'daemon', to: 'mysql', class: 'mysql-daemon-line'},
             {from: 'device', to: 'mysql', class: 'mysql-device-line'},
             {from: 'environment', to: 'mysql', class: 'mysql-environment-line'},
             {from: 'user', to: 'mysql', class: 'mysql-user-line'},
             {from: 'frontend', to: 'mysql', class: 'mysql-frontend-line'}
         ];

        function positionContainers() {
            const canvas = document.querySelector('.canvas');
            const centerX = 500;
            const centerY = 375;
            const radius = 300;
            const cardWidth = 240;
            const cardHeight = 120;
            const circleServices = services.slice(0, 6); // First 6 in circle
            const angleStep = (2 * Math.PI) / circleServices.length;
            let positions = {};

            // Position circle services
            circleServices.forEach((service, i) => {
                const angle = i * angleStep - Math.PI / 2; // start from top
                const x = centerX + radius * Math.cos(angle) - cardWidth / 2;
                const y = centerY + radius * Math.sin(angle) - cardHeight / 2;
                positions[service] = {x, y};
                const card = document.getElementById(`${service}-card`);
                card.style.left = `${x}px`;
                card.style.top = `${y}px`;
            });



            // Draw lines
            const svg = document.querySelector('.connection-lines');
            svg.innerHTML = `<defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#61dafb;stop-opacity:0.8" />
                    <stop offset="50%" style="stop-color:#61dafb;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#61dafb;stop-opacity:0.8" />
                </linearGradient>
            </defs>`;

            connections.forEach(conn => {
                const fromPos = positions[conn.from];
                const toPos = positions[conn.to];
                const fromX = fromPos.x + cardWidth / 2;
                const fromY = fromPos.y + cardHeight / 2;
                const toX = toPos.x + cardWidth / 2;
                const toY = toPos.y + cardHeight / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${fromX} ${fromY} L ${toX} ${toY}`);
                path.classList.add('connection-line', conn.class);
                svg.appendChild(path);
            });
        }

        function updateDashboard() {
            fetch('/dashboard/data')
                .then(response => response.json())
                .then(data => {
                    // Update daemon metrics
                    updateServiceMetrics('daemon', data.daemon);

                    // Update environment metrics
                    updateServiceMetrics('environment', data.environment);

                    // Update frontend metrics (uses real system metrics)
                    updateServiceMetrics('frontend', data.frontend);

                    // Update device metrics
                    updateServiceMetrics('device', data.device);

                    // Update MySQL metrics
                    updateMySQLMetrics(data.mysql);

                    // Update user metrics
                    updateServiceMetrics('user', data.user);

                    // Update user clusters
                    updateUserClusters(data.users);
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                });
        }

        function updateServiceMetrics(serviceName, serviceData) {
            // Update CPU
            const cpuBar = document.getElementById(`${serviceName}-cpu-bar`);
            const cpuValue = document.getElementById(`${serviceName}-cpu-value`);
            if (cpuBar && cpuValue) {
                const cpuPercent = Math.round(serviceData.cpu);
                cpuBar.style.width = `${cpuPercent}%`;
                cpuValue.textContent = `${cpuPercent}%`;
            }

            // Update Memory
            const memBar = document.getElementById(`${serviceName}-mem-bar`);
            const memValue = document.getElementById(`${serviceName}-mem-value`);
            if (memBar && memValue) {
                const memPercent = Math.round(serviceData.memory);
                memBar.style.width = `${memPercent}%`;
                memValue.textContent = `${memPercent}%`;
            }

            // Update Errors
            const errors = document.getElementById(`${serviceName}-errors`);
            if (errors) {
                errors.textContent = serviceData.errors || 0;
            }

            // Update health indicator
            const health = document.getElementById(`${serviceName}-health`);
            if (health) {
                const status = serviceData.status;
                if (status === 'healthy') {
                    health.style.backgroundColor = 'var(--good)';
                } else if (status === 'warning') {
                    health.style.backgroundColor = 'var(--warn)';
                } else {
                    health.style.backgroundColor = 'var(--bad)';
                }
            }
        }

        function updateMySQLMetrics(mysqlData) {
            // Update connections
            const connections = document.getElementById('mysql-connections');
            if (connections) {
                connections.textContent = mysqlData.connections || 0;
            }

            // Update tables (static for now, could be made dynamic)
            const tables = document.getElementById('mysql-tables');
            if (tables) {
                tables.textContent = mysqlData.tables || 8;
            }

            // Update health indicator
            const health = document.getElementById('mysql-health');
            if (health) {
                const status = mysqlData.status;
                if (status === 'healthy') {
                    health.style.backgroundColor = 'var(--good)';
                } else if (status === 'warning') {
                    health.style.backgroundColor = 'var(--warn)';
                } else {
                    health.style.backgroundColor = 'var(--bad)';
                }
            }
        }

        function updateUserClusters(users) {
            console.log('Users:', users);
            updateCluster('users-cluster', users);
        }

        function updateCluster(clusterId, users) {
            const cluster = document.getElementById(clusterId);
            // Remove existing user cards
            const existingCards = cluster.querySelectorAll('.user-card');
            existingCards.forEach(card => card.remove());

            if (users.length === 0) return;

            // Horizontal positioning to fit canvas
            const n = users.length;
            const totalWidth = 800;
            const cardWidth = 120;
            const spacing = n > 1 ? (totalWidth - cardWidth) / (n - 1) : 0;
            const startX = (1000 - totalWidth) / 2 + cardWidth / 2;
            const y = 100 - 25; // centerY - cardHeight/2

            // Create new cards
            users.forEach((user, index) => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div class="node-health" style="background-color: ${user.type === 'resident' ? 'var(--good)' : 'var(--warn)'}"></div>
                    <div class="user-username">${user.username}</div>
                    <div class="user-device">${user.device}</div>
                `;
                // Position horizontally
                const x = startX + index * spacing - cardWidth / 2;
                card.style.left = `${x}px`;
                card.style.top = `${y}px`;
                cluster.appendChild(card);
                // Animate in
                setTimeout(() => card.classList.add('show'), index * 100);
            });
        }

        // Position containers and draw lines
        positionContainers();

        // Update dashboard immediately and then every 5 seconds
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>